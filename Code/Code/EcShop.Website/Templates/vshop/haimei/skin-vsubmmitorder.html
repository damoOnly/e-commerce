<hi:common_vheader runat="server" />
<!--<script>
    $(function () {
        $.ajax({
            type: "Get",
            url: "/Handler/MemberHandler.ashx?action=GetUserInfo",
            datatype: "json",
            async: false,
            success: function (data)
            {
                    $("#txtmemberIdentityCard").val(data.data[0].IdentityCard);
                    $("#txtRealName").val(data.data[0].RealName);
            }
        });
    });
</script>-->
<div class="page gray-page">
    <section>
        <div class="addr-info">
            <asp:Literal runat="server" id="litAddressNotExits" />
            <!--<div class="no-addr"> <span class="n-tip">您还没有收货地址！</span><a class="add-addr-btn">添加收货地址</a> </div>
            <div class="addr-con" id="addr-con"> <a href="/vshop/ShippingAddresses.aspx" id="addressurl">
                <p>
                    <label >深圳 罗湖嘉宾 太平洋</label>
                </p>
                <div class="rec-info fix">
                    <label >黄先生</label>
                    <span class="ml10">
                    <label>13265695562</label>
                    </span> </div>
                </a> </div>-->
        </div>

        <div class="sm-con mt10 mb10 pl10 pr10">
            <div class="dis-none">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                    <asp:Literal runat="server" id="litShipTo" />
                    <asp:Literal runat="server" id="litCellPhone" />
                    <asp:Literal runat="server" id="litAddress" />
                    <span class="caret"></span><span class="caret"></span>
                </button>
                <ul class="dropdown-menu " role="menu">
                    <hi:vshoptemplatedrepeater id="rptAddress" templatefile="/Tags/skin-Common_Addresses.ascx" runat="server" />
                    <li class="divider"></li>
                    <li><a href="/vshop/AddShippingAddress.aspx">新增收货地址</a></li>
                </ul>
                <input type="hidden" runat="server" clientidmode="Static" id="selectShipTo" />
            </div>

            <div id="storeAddressdiv">
            </div>
			<div class="fix">
            	<label class="gray-lb">送货时间</label>
            <div class="btn-group selectShipToDate">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"> 时间不限<span class="caret"></span> </button>
                <ul class="dropdown-menu" role="menu">
                    <li><a href="#" name="时间不限">时间不限</a></li>
                    <li><a href="#" name="周一至周五">周一至周五</a></li>
                    <li><a href="#" name="周六及公众假期">周六及公众假期</a></li>
                </ul>
                <input type="hidden" runat="server" clientidmode="Static" id="selectShipToDate" value="时间不限" />
            </div>
            </div>
            <!---配送方式---->
            <!--      <div class="btn-group selectShippingType">
                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">请选择配送方式<span class="caret"></span></button>
                     <ul id="shippingTypeUl" class="dropdown-menu" role="menu">
                     </ul>
                    <input type="hidden" runat="server" clientidmode="Static" id="selectShippingType" />
                </div>  -->
            <div class="fix">
            	<label  class="gray-lb">支付方式</label>
                <div class="btn-group selectPaymentType">
                    <hi:common_paymenttypeselect runat="server" />
                    <input type="hidden" runat="server" clientidmode="Static" id="selectPaymentType" />
                </div>
            </div>
            <div class="fix" style="display:none">
            	<label  class="gray-lb">真实姓名</label>
                <dl class="sm-dl fix">
                    <dd>
                        <div class="input-con">
                            <input type="text" id="txtRealName" runat="server" clientidmode="Static" class="form-control"   placeholder="请填写真实姓名" />
                        </div>
                    </dd>
                </dl>
            </div>
            <div class="fix" style="display:none">
                <label class="gray-lb">身份证号码</label>
                <dl class="sm-dl fix">
                    <dd>
                        <div class="input-con">
                            <input type="text" id="txtmemberIdentityCard" runat="server" clientidmode="Static"  class="form-control" placeholder="请填写收货人的真实身份证号码" />
                        </div>
                    </dd>
                </dl>
            </div>
            <div class="fix showcoupon">
            	<label  class="gray-lb">选择优惠券</label>
                <div class="btn-group coupon">
                    <hi:common_couponselect id="dropCoupon" cssclass="mod_select" runat="server"  />
                    <input type="hidden" runat="server" clientidmode="Static" id="selectCoupon" />
                </div>
            </div>
            <!--<div class="btn-group voucherCont">
                <fieldset class="x-fieldset">
                    <legend>使用现金券</legend>
                    <div><input type="text" id="txtVoucherCode" class="form-control" placeholder="请填写现金券号码" /></div>
                    <div><input type="text" id="txtVoucherPwd" class="form-control" placeholder="请填写现金券密码" /></div>
                    <div id="btnUseVoucher" class="btn btn-danger btn-block btnUseVoucher">使用线下现金券</div>

                    <div id="divMyVoucherList">

                        <div class="btn-group voucher">
                            <hi:Common_VoucherSelect id="dropVoucher" cssclass="mod_select" runat="server" />
                            <input type="hidden" runat="server" clientidmode="Static" id="selectVoucher" />
                        </div>
                    </div>
                </fieldset>
            </div>-->
            <div class="sm-ct-list mb10" id="pd-list">
                <label class="gray-lb">商品清单</label>
                <div class="ct-list">
                    <ul class="fix">
                        <hi:vshoptemplatedrepeater id="rptCartProducts" templatefile="/Tags/skin-Common_SubmmitCartProducts.ascx" runat="server" />
                    </ul>
                </div>
            </div>
            <div class="sb-bar fix"> <a class="sb-back" id="orderProductsChange" href="/vshop/shoppingCart.aspx">返回购物车修改</a> </div>
            <div class="fix">
            	<label  class="gray-lb">备注</label>
                <dl class="sm-dl fix">
                    <dd>
                        <textarea id="remark" class="textarea" rows="3" placeholder="订单备注（选填）"></textarea>
                    </dd>
                </dl>
            </div>
            <div class="order-summer">
                <hi:vshoptemplatedrepeater id="rptPromotions" templatefile="/Tags/skin-Common_VPromotions.ascx" runat="server" />
                <p>
                    <label>商品总金额：</label>
                    <span class="price product-amount">
                        &yen;
                        <span id="showTotalPrice"><asp:Literal runat="server" id="litProductTotalPrice" /></span>
                    </span>
                </p>
                <p>
                    <label>运费：</label>
                    <span class="price">
                        &yen;
                        <!--<span id="showfreight">--><asp:Literal runat="server" id="litToalFreight" /><!--</span>-->
                    </span>
                </p>
                <p>
                    <label>税费：</label>
                    <span class="price tax">
                        &yen;
                        <span id="showtax"><asp:Literal runat="server" id="litTotalTax" /></span>
                </p>
                <p  style="display:none">
                    优惠抵扣：<span class="price">
                        &yen;
                        <asp:Literal runat="server" id="litPromotionPrice" />
                    </span>
                </p>
            </div>
        </div>
    </section>
    <div class="sb-summer">
        <a id="aSubmmitorder" class="btn-link">提交订单</a>
        <div class="total-summer">
            合计：&yen;
            <asp:Literal runat="server" id="litOrderTotal" />
        </div>
    </div>
    <div style="display:none" class="totalQuantity">
        <asp:Literal runat="server" id="litTotalQuantity" />
    </div>
    <input type="hidden" id="regionId" runat="server" clientidmode="Static" />
    <input type="hidden" id="isCustomsClearance" runat="server" clientidmode="Static" />
    <!---<input type="hidden" id="memberIdentityCard" runat="server" clientidmode="Static" />-->
    <input type="hidden" id="groupbuyHiddenBox" runat="server" clientidmode="Static" />
    <input type="hidden" id="htmlIsCanMergeOrder" runat="server" clientidmode="Static" />

</div>
<script>
    var unpack = 0;
    var merge = 0;
    var goto = false;
    $('.rptAddress li a').click(function () {
        $('.rptAddress button').html($(this).attr('briefAddress') + '<span class="caret"></span>');
        var regionId = $(this).attr('name');
        var shippingId = $(this).attr('shippingId');
        $('#selectShipTo').val(shippingId);
        $('#txtmemberIdentityCard').val($(this).siblings('.identity').val());
        var curRegins = $(this).attr("briefaddress");
        if (curRegins != '') {
            var curRealName = curRegins.substring(0, curRegins.indexOf(' '));
            $('#txtRealName').val(curRealName);
        }

        //refreshShippingTypes(regionId);

    });

    $('.selectPaymentType li a').click(function () {
        $('.selectPaymentType button').html($(this).html() + '<span class="caret"></span>');
        $('#selectPaymentType').val($(this).attr('name'));

    });

    $('.selectShipToDate li a').click(function () {
        $('.selectShipToDate button').html($(this).html() + '<span class="caret"></span>');
        $('#selectShipToDate').val($(this).attr('name'));
    });

    $('.coupon li a').click(function ()
    {
       
        if (!VoucherVsCoupon(1))
            return;
        $('.coupon button').html($(this).html() + '<span class="caret"></span>');
        $('#selectCoupon').val($(this).attr('name'));
        var oldCouponCost = parseFloat($('#couponcost').html());
        var newCouponCost = parseFloat($(this).attr('value'));
        $('#couponcost').html(newCouponCost);
        var total = parseFloat($('#total').html());
        total += oldCouponCost;
        total -= newCouponCost;
        $('#total').html(total.toFixed(2));
    });

    $('.voucher li a').click(function () {

        if ($('#txtVoucherCode').val() != "" && $('#txtVoucherCode').val() != "请填写现金券号码") {
            alert("已经输入现金券不能再选择其它现金券");
            return;
        }
        if (!VoucherVsCoupon(0))
            return;
        $('.voucher button').html($(this).html() + '<span class="caret"></span>');
        $('#selectVoucher').val($(this).attr('name'));
        SetVoucher($(this).attr('value'));

    });

    function SetVoucher(discountAmount) {
        var oldVoucherCost = parseFloat($('#vouchercost').html());
        var newVoucherCost = parseFloat(discountAmount);
        $('#vouchercost').html(newVoucherCost);
        var total = parseFloat($('#total').html());
        total += oldVoucherCost;
        total -= newVoucherCost;
        $('#total').html(total.toFixed(2));
    }

    function VoucherVsCoupon(checkType)
    {
        var msg = "一次只能使用优惠券和现金券中的一种";
        if (checkType == 1)
        {
            var selectVoucher = $('#selectVoucher').val();
            if (selectVoucher != "" && selectVoucher != undefined)
            {
                alert(msg);
                return false;
            }
        } else {
            var selectCoupon = $('#selectCoupon').val();
            if (selectCoupon != "" && selectCoupon != undefined) {
                alert(msg);
                return false;
            }
        }
        return true;

    }

    function registSelectShippingType() {

        $('.selectShippingType li a').click(function () {
            $('.selectShippingType button').html($(this).html() + '<span class="caret"></span>');
            $('#selectShippingType').val($(this).attr('name'));

            var oldShipCost = parseFloat($('#shipcost').html());
            var newShipCost = parseFloat($(this).attr('value'));

            $('#shipcost').html(newShipCost);
            var total = parseFloat($('#total').html());
            total -= oldShipCost;
            total += newShipCost;
            $('#total').html(total.toFixed(2));
        });

    }




    function refreshShippingTypes(regionId) {
        $.post('/api/vshopprocess.ashx?action=GetShippingTypes',
         {
             regionId: regionId,
             buyAmount: getParam('buyAmount'),
             productSku: getParam('productSku'),
             groupBuyId: $('#groupbuyHiddenBox').val()
         },

         function (shippingTypes) {
             $('#shippingTypeUl li').remove();
             var html = '';
             $.each(shippingTypes.data, function (i, shippingType) {
                 html += '<li><a href="#" name="' + shippingType.modelId + '" value="' + shippingType.freight + '">' + shippingType.text + '</a></li>';
             });
             $('.selectShippingType button').html('请选择配送方式<span class="caret"></span>');
             $('#shippingTypeUl').html(html);
             $('#selectShippingType').val('');

             //修改总价
             var oldShipCost = parseFloat($('#shipcost').html());
             var total = parseFloat($('#total').html());
             total -= oldShipCost;
             $('#total').html(total.toFixed(2));
             $('#shipcost').html('0.00');
             registSelectShippingType();

         }, "json");


    }


    $(function ()
    {

        var tax = $("#showtax").html();
        if (parseInt(tax) <= 50) {
            $("#showtax").css("text-decoration", "line-through");
        } else {
            $("#showtax").css("text-decoration", "");
        } 
        registSelectShippingType();
        //隐藏余额支付
        var $eleA = $('#selectPaymentType li a');
        $eleA.each(function (i, n) {
            var payName = $.trim($(this).html());
            if (payName == '帐户余额支付') {
                $(this).parent().hide();
            }
        });
        //默认选中微信支付
        $('.selectPaymentType button').html('微信支付<span class="caret"></span>');
        $('#selectPaymentType').val(-2);
        //团购时，去掉货到付款
        if (getParam('from') == "groupBuy" || getParam('from') == "countDown") {
            $('#selectPaymentType a[name="0"]').parent().remove();
            $('.showcoupon').hide();
            //$('.coupon').hide();
            $('.detailLink').attr('href', '/vshop/GroupBuyProductDetails.aspx?groupBuyId=' + getParam('groupbuyId'));
            $('#orderProductsChange').hide();
        }

        if (getParam('from') == 'signBuy')
            $('#orderProductsChange').hide();


        if ($('.coupon li').length == 0)
            $('.showcoupon').hide();
            //$('.coupon').hide();


        if ($('.voucher li').length == 0)
            $('.voucher').hide();

        var regionId = $('#regionId').val();
        //refreshShippingTypes(regionId);

        $('hr.hr').last().hide();

        var productSkus = $('.specification');
        $.each(productSkus, function (i, productSKU) {
            var text = '';
            productSKU = $(productSKU);
            var skus = productSKU.find('input[name="skucontent"]');
            $.each(skus.val().split(';'), function (i, sku) {
                if ($.trim(sku))
                    text += '<span class="badge-h">' + sku.split('：')[1] + '</span>';
            });
            var promotionShortName = productSKU.find('input[name="promotionShortName"]').val();
            if (promotionShortName) {
                var promotionName = productSKU.find('input[name="promotionName"]').val();
                text += '<span class="badge-h danger" onclick="alert_h(\'' + promotionName + '\')">' + promotionShortName + '</span>';
            }
            productSKU.html(text);
        });

    });


    $("body").addClass("order-body");

    $("#btnUseVoucher").click(function () {
        if ($("#selectVoucher").val() != "" && $("#txtVoucherCode").val() != "请填写现金券号码") {
            alert("已经选择现金券不能再输入其它现金券！");
            return;
        }
        if (!VoucherVsCoupon(0))
            return;
        var voucherCode = $('#txtVoucherCode').val();
        var voucherPwd = $('#txtVoucherPwd').val();
        var orderAmount = parseFloat($.trim($(".product-amount").html().replace("¥", "")));
        var url = "/api/vshopprocess.ashx?action=UseVoucher&txtVoucherCode=" + voucherCode + "&txtVoucherPwd=" + voucherPwd + "&orderTotal=" + orderAmount;
        $.post(url, null,
            function (amount) {
                if (amount != undefined && amount.Amount != 0) {
                    SetVoucher(amount.Amount);
                } else {
                    alert("您输入的现金券无效请重新输入！");
                }
            });
    });
</script>
<script src="/utility/vshoping.helper.js?v=20160325" type="text/javascript"></script>